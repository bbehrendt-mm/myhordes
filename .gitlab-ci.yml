# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/PHP.gitlab-ci.yml

image: registry.gitlab.com/eternaltwin/myhordes/myhordes-registry:latest

# Bring in any services we need http://docs.gitlab.com/ee/ci/docker/using_docker_images.html#what-is-a-service
# See http://docs.gitlab.com/ee/ci/services/README.html for examples.
services:
  - mariadb:latest

# Set any variables we need
variables:
  # Configure mysql environment variables (https://hub.docker.com/r/_/mysql/)
  # MYSQL_DATABASE: myhordes
  MARIADB_ROOT_PASSWORD : MyH0rd3sD@tAbaze!
  DATABASE_URL: mysql://root:MyH0rd3sD@tAbaze!@mariadb:3306/myhordes
  XDEBUG_MODE: coverage

stages:
  - build
  - test-translate
  - deploy

build:
  stage: build
  script:
    # Run Composer
    - composer require myhordes/prime:0.0.1
    - composer install
    # Install assets
    - yarn install
    - yarn encore dev
    # Install default DB
    # - php bin/console app:migrate -i -vvv
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - vendor
      - node_modules
      - public/build
      - templates/build
  rules:
    - changes:
        - composer.json
        - package.json
        - composer.lock
        - yarn.lock
        - assets/**/*

translate:
  stage: test-translate
  dependencies:
    - build
  script:
    # Install a DB
    - php bin/console app:migrate -i -vvv --skip-optional
    # Let's generate source strings
    - bin/console app:translation:update de
    # And we send it to Crowdin
    - crowdin upload sources -b translation-main
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - vendor
      - node_modules
      - public/build
      - templates/build
  rules:
    - if: $CI_PIPELINE_SOURCE != "push"
      when: never
    - if: $CI_COMMIT_TAG =~ /^translate-\d+/
      when: on_success
  variables:
    CROWDIN_API_TOKEN: $CROWDIN_API_TOKEN
    CROWDIN_PROJECT_ID: $CROWDIN_PROJECT_ID

# Run our tests
# If Xdebug was installed you can generate a coverage report and see code coverage metrics.
test:
  stage: test-translate
  dependencies:
    - build
  script:
    # Install a DB
    - php bin/console app:migrate -i -vvv
    # Run tests
    - vendor/bin/phpunit # --coverage-text --colors=never
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - vendor
      - node_modules
      - public/build
      - templates/build
  except:
    refs:
      - /^l10n_.*/

quodana:
  stage: test-translate
  image:
    name: jetbrains/qodana-php:2023.1-eap
    entrypoint: [ "" ]
  variables:
    QODANA_REMOTE_URL: git@$CI_SERVER_HOST:$CI_PROJECT_PATH.git
    QODANA_BRANCH: $CI_COMMIT_BRANCH
    QODANA_REPO_URL: $CI_PROJECT_URL
    QODANA_JOB_URL: $CI_JOB_URL
  script:
    - qodana --save-report --results-dir=$CI_PROJECT_DIR/qodana --report-dir=$CI_PROJECT_DIR/qodana/report
  artifacts:
    paths:
      - qodana/report/
    expose_as: 'Qodana report'

deploy_staging:
  stage: deploy
  dependencies:
    - test
  script:
    - apt-get update -yqq
    - apt-get install -yqq sshpass
    - export SSHPASS=$SSH_PASSWORD
    - sshpass -e ssh -p 2244 -o stricthostkeychecking=no deployer@newhope.aifesdespets.fr 'cd /var/www/chehtan.dev/myhordes/www && bin/console app:migrate -g --remote origin --branch Dev-Ludofloria --environment dev --phar --release'
    - unset SSHPASS
  only:
    - master
  environment:
    name: ludo-staging
    url: https://myhordes.chehtan.dev