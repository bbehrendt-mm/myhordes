{% extends "ajax/ajax.html.twig" %}
{% block ajax %}
    <div class="row">
        <div class="cell padded header rw-12">
            <h4>{% trans from 'ghost' %}Wähle eine Stadt{% endtrans %}</h4>
            <div class="row">
                <div class="cell rw-8 rw-md-12">
                    {% for townClass in townClasses %}

                        {% set found = false %}
                        {% for town in townClass.towns %}
                            {% if town.open %}{% set found = true %}{% endif %}
                        {% endfor %}

                        <h5>{{ townClass.getLabel|trans({},'game') }}</h5>
                        {% if found %}
                            <div class="row-table">
                                <div class="row header">
                                    <div class="padded cell rw-8">{% trans from 'ghost' %}Stadtname{% endtrans %}</div>
                                    <div class="padded cell rw-4">{% trans from 'ghost' %}Aktionen{% endtrans %}</div>
                                </div>
                                {% for town in townClass.towns %}
                                    {# @var town \App\Entity\Town #}
                                    {% if town.open %}
                                        {% set found = true %}
                                        <div class="row">
                                            <div class="padded cell rw-1"><span class="language">{{ town.getLanguage }}</span></div>
                                            <div class="padded cell rw-7">{{ town.getName }}</div>
                                            <div class="padded cell rw-1 center"><img x-town-details="{{ town.id }}" x-town-toggle="{{ town.id }}" class="pointer" alt="+" src="{{ asset('build/images/small_more.gif') }}" /></div>
                                            <div class="padded cell rw-3"><button x-town-lang="{{ town.getLanguage }}" x-town-id="{{ town.id }}">{% trans from 'ghost' %}Beitreten{% endtrans %}</button></div>
                                            <div x-town-details="{{ town.id }}" class="padded cell rw-12 hidden">
                                                <ul class="citizen-list">
                                                    {% for denizen in town.citizens %}
                                                        {# @var denizen \App\Entity\Citizen #}
                                                        <li>
                                                            {% if denizen.alive %}
                                                                <img src="{{ asset('build/images/professions/' ~ denizen.profession.icon ~ '.gif') }}" alt="{{ denizen.profession.label|trans({},'game') }}" />
                                                            {% else %}
                                                                <img src="{{ asset('build/images/professions/death.gif') }}" alt="{{ denizen.profession.label|trans({},'game') }}" />
                                                            {% endif %}
                                                            {{ denizen.user.username }}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                                <div class="right"><span class="small pointer" x-town-toggle="{{ town.id }}">{{ 'Schließen'|trans({},'global') }}</span></div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                        {% else %}
                            <span class="small">{% trans from 'ghost' %}Aktuell gibt es keine Stadt diesen Typs.{% endtrans %}</span>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="cell rw-4 rw-md-12">
                    ADD HELP CONTENT HERE
                </div>
            </div>

        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        $.html.addEventListenerAll( '[x-town-toggle]', 'click', function(e,elem) {
            const id = elem.getAttribute('x-town-toggle');
            document.querySelectorAll('[x-town-details="' + id + '"]').forEach(function( target ) {
                if (target.classList.contains('hidden')) target.classList.remove('hidden');
                else target.classList.add('hidden');
            })
        } );

        $.html.addEventListenerAll( 'button[x-town-id][x-town-lang]', 'click', function(e,elem) {
            e.preventDefault();

            const user_lang = '{{ app.request.locale|e('js') }}';
            const town_lang = elem.getAttribute('x-town-lang');
            if (user_lang && town_lang && user_lang.split('_')[0] !== town_lang.split('_')[0]) {
                let message =
                    ('{{ 'Die Sprache der gewählten Stadt ist %lang_town%. Deine aktuelle Spracheinstellung ist %lang_user%.'|trans({},'ghost')|e('js') }}' + "\n\n" +
                    '{{ 'Wenn du dieser Stadt beitrittst, wird die Sprache von MyHordes für die Dauer der Stadt auf %lang_town% festgelegt.'|trans({},'ghost')|e('js') }}'  + "\n\n" +
                    '{{ 'Kommunikation ist wichtig in MyHordes. Bitte betritt keine Stadt, deren Sprache du nicht beherrscht. Möchtest du fortfahren?'|trans({},'ghost')|e('js') }}')
                    .replace(/%lang_user%/g, window.c.langs[user_lang.split('_')[0]] ?? user_lang).replace(/%lang_town%/g, window.c.langs[town_lang.split('_')[0]] ?? town_lang);

                if (!confirm(message)) return;
            } else if (!confirm('{{ 'Bestätigen'|trans({},'ghost')|e('js') }}'))
                return;

            $.ajax.easySend( '{{ path('api_join') }}', {town: elem.getAttribute('x-town-id')},
                function () {
                    $.ajax.load(null, '{{ path('game_landing') }}', true);
                } )
        } );
    </script>
{% endblock %}