{% extends "ajax/game/beyond/beyond.html.twig" %}
{% block menu_text %}
    {{ parent() }}
{% endblock %}
{# @var zone \App\Entity\Zone #}
{# @var citizen \App\Entity\Citizen #}
{% block content %}
    {% set hour = "now"|date("G") %}
    <div class="row">
        <div class="cell rw-12 zone-beyond time-{{ hour }} {% if hour < 7 or hour > 18 %}night-{% endif %}{% if zone.x == 0 and zone.y == 0 %}city{% elseif zone.prototype and zone.prototype.id > 0 %}oldruins{% else %}outerworld{% endif %}{% if zone.x == 0 and zone.y == 0 and zone.town.door == 1 %}-open{% endif %}"></div>
    </div>
    <div class="row">
        <div class="cell rw-12 {% if not zone.prototype %}ambiant {% endif %}small">
            {% if zone.x == 0 and zone.y == 0 %}
                <p>{% trans from 'game' %}Du lässt deinen Blick schweifen. Direkt vor dir erstreckt sich die gottverlassene Landschaft der Außenwelt. Du denkst an die anderen Stadtbewohner, die sich gerade draußen befinden und in den Ruinen graben. Du malst dir die Leiden all derer aus, die nicht mehr zurückkehren werden.{% endtrans %}</p>
                <p>{% trans from 'game' %}Möchtest du nun also nach draußen gehen oder entscheidest du dich dafür, in der Stadt zu bleiben? Manche sagen, dass man verrückt, andere wiederum, dass man gewieft sein muss, um die Außenwelt zu erkunden. Vielleicht trifft ja beides zu...{% endtrans %}</p>
            {% else %}
                {% if zone.prototype %}
                    <div class="ruin-info">
                        {% if zone.buryCount > 0 %}
                            <b>{{ 'Verschüttete Ruine'|trans({},'game') }}</b>
                            {% if scout %}<b>(<i>{{ zone.prototype.label|trans({}, 'game') }}</i>)</b>{% endif %}
                            <br />
                            {{ 'Es muss noch aufgeräumt werden'|trans({},'game') }}:
                            <div class="ruin-bury-count">{% for p in 1..zone.buryCount %}<div></div>{% endfor %}</div>
                        {% else %}
                            <img src="{{ asset('build/images/small_help.gif') }}" /> <span class="ruin-name">{{ 'Ruine'|trans({},'game') }} : <b>{{ zone.prototype.label|trans({}, 'game') }}</b></span><br />
                            <span class="ruin-desc">{{ zone.prototype.description|trans({}, 'game') }}</span>
                        {% endif %}

                    </div>
                {% else %}
                    <p class="beyond-rp">
                        <img alt="" src="{{ asset('build/images/small_rp.gif') }}" />
                        {% if hour >= 7 and hour <= 18 %}
                            {% trans from 'game' %}Die Wüste erstreckt sich, so weit das Auge reicht... Wie viele Männer sind in dieser Weite verloren gegangen? Wer weiß, ob Sie nicht der Nächste sind?{% endtrans %}
                        {% else %}
                            {% trans from 'game' %}Die Wüstennächte sind bitterkalt... Eine dicke Staubwolke umhüllt dich und du hörst schauriges Gekreische in deiner Umgebung. Ab und zu glaubst du eine unförmige Gestalt im Schatten wandeln zu sehen. Vielleicht geht auch nur deine Fantasie mit dir durch...{% endtrans %}
                        {% endif %}
                    </p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% if (zone.x != 0 or zone.y != 0) and conf.get(constant('App\\Structures\\TownConf::CONF_FEATURE_CAMPING'),false) %}
        <div class="row">
            <div class="cell rw-12 zone-camp">
                <input type="checkbox" name="zone-camp" id="zone-camp"{% if citizen_hidden %} checked="checked"{% endif %} /><label for="zone-camp">{% trans from 'game' %}Die Zone untersuchen{% endtrans %}</label>
                <div class="zone-camp-info">
                    <p>{% trans from 'game' %}Du schaust dir die Gegend etwas genauer an...{% endtrans %}</p>
                    {% if camping_zone != "" %}
                        <p>{{ camping_zone|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_zombies != "" %}
                        <p>{{ camping_zombies|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_chance != "" %}
                        <p class="emphasis">{{ camping_chance|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_improvable != "" %}
                        <p>{{ camping_improvable }}</p>
                    {% endif %}
                    {% if camping_debug != "" %}
                        <pre>{{ camping_debug }}</pre>
                    {% endif %}
                    {% embed "ajax/game/camping.html.twig" with {'list': camping, 'hidden': citizen_hidden} %}
                    {% endembed %}
                </div>
            </div>
        </div>
    {% endif %}
    {% if zone_blocked %}
        <div class="row">
            <div class="cell rw-12">
                <div class="zone-blocked-warning">
                    <b>
                        {% if zone_escape > 0 %}
                            {% trans from 'game' %}Temporäre Zonenkontrolle{% endtrans %}
                        {% else %}
                            {% trans with { '%z%': zone_zombies } from 'game' %}%z% Zombies kontrollieren diese Zone!{% endtrans %}
                        {% endif %}
                    </b><br />
                    <span>
                        {% if zone_escape > 0 %}
                            {% trans from 'game' %}
                                Das ist deine Chance - ergreife sie und fliehe! In Kürze werden die Zombies die Kontrolle über die Zone zurückerlangen. Dir verbleiden:
                            {% endtrans %}
                            <span x-countdown="{{ zone_escape }}" x-on-expire="reload">...</span>
                        {% elseif active_scout_mode %}
                            <br />
                            {% trans from 'game' %}
                                Dank deiner Tarnung kannst du dich dennoch bewegen - werde nur nicht zu übermütig...
                            {% endtrans %}
                            <br /><br />
                            <b>{{ 'Achtung'|trans({},'global') }}</b>: {% trans from 'game' %}
                                Bestimmte Aktionen können deine Tarnung auffliegen lassen!
                            {% endtrans %}
                        {% else %}
                            {% trans from 'game' %}
                                Du wurdest überrascht und bist jetzt von den Zombies umzingelt! Wenn du nichts unternimmst und dir niemand zu Hilfe eilt, wirst du ohne Zweifel heute Abend hier verrecken ...
                            {% endtrans %}
                        {% endif %}
                    </span>
                    {% if zone_escape <= 0 and not active_scout_mode %}
                        <div class="row">
                            <div class="padded-small cell rw-6"><button x-ajax-href="{{ url('forum_town_redirect') }}"><img alt="" src="{{ asset('build/images/attacked.gif') }}" />{% trans from 'game' %}Hilfe rufen!{% endtrans %}</button></div>
                            <div {% if not can_escape %}disabled{% endif %} class="padded-small cell rw-6"><button id="escape-btn"><img alt="" src="{{ asset('build/images/death.gif') }}" />{% trans from 'game' %}Die Flucht wagen!{% endtrans %}</button></div>
                        </div>
                        <div class="row">
                            <div {% if not can_attack %}disabled{% endif %} class="padded-small cell rw-8"><button id="attack-btn"><img alt="" src="{{ asset('build/images/fist.gif') }}" />{% trans from 'game' %}Gegen einen Zombie kämpfen!{% endtrans %} (<div class="ap">1</div>)</button></div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    {% endif %}
    <div class="row">
        <div class="padded cell rw-6 rw-md-12">
            {% if zone.digs <= 0 %}
                <h5>{% trans from 'game' %}Diese Zone{% endtrans %}</h5>

                {% if zone.digs <= 0 %}
                    <div class="note">
                        <img alt="" src="{{ asset('build/images/Small_broken.gif') }}" />
                        {% trans from 'game' %}
                            Diese Zone ist leergesucht. Du wirst hier keine wertvollen Gegenstände mehr finden können.
                        {% endtrans %}
                    </div>
                {% endif %}
            {% endif %}


            <h5>{% trans from 'game' %}Meine Aktionen{% endtrans %}</h5>

            {% if zone.x != 0 or zone.y != 0 %}
                {% if not citizen_hidden %}
                    {% if not digging %}
                        {% if zone_blocked %}
                            <div class="note">
                                <img class="icon left" alt="" src="{{ asset('build/images/lock.gif') }}" />
                                {% trans from 'game' %}Während Zombies die Zone kontrollieren, kannst du nicht graben.{% endtrans %}
                            </div>
                        {% elseif citizen.digTimeout > 0 %}
                            <div class="note">
                                <img class="icon left" alt="" src="{{ asset('build/images/lock.gif') }}" />
                                {% trans from 'game' %}Du hast hier bereits vor Kurzem gegraben. Die nächste Ausgrabung ist möglich in:{% endtrans %}
                                <b x-countdown="{{ citizen.digTimeout }}" x-on-expire="reload">...</b>
                            </div>
                        {% endif %}
                        <button id="dig_button" {% if zone_blocked or citizen.digTimeout > 0 %}disabled{% endif %}>
                            <img class="icon left" alt="" src="{{ asset('build/images/small_gather.gif') }}" />
                            {% trans from 'game' %}In dieser Zone graben{% endtrans %}</button>
                    {% else %}
                        <div class="note">
                            <img class="icon left" alt="" src="{{ asset('build/images/small_gather.gif') }}" />
                            {% trans from 'game' %}Nächste automatische Ausgrabung:{% endtrans %}
                            <span x-countdown="{{ citizen.digTimeout }}" x-on-expire="reload">...</span>
                        </div>
                    {% endif %}
                    {% if zone.prototype %}
                        <button id="dig_ruin_button" {% if not dig_ruin or zone.buryCount > 0 %}disabled{% endif %} >
                            {% if (zone_blocked and active_scout_mode) %}
                                <img class="icon right" alt="" src="{{ asset('build/images/uncloak.gif') }}" />
                            {% endif %}
                            <img class="icon left" alt="" src="{{ asset('build/images/small_view.gif') }}" />
                            {% set ruin_label = zone.prototype.label|trans({},'game') %}
                            {% if zone.buryCount > 0 %}{% set ruin_label = 'Verschüttete Ruine'|trans({},'game') %}{% endif %}
                            {% trans with {'%ruin%': ruin_label} from 'game'  %}%ruin% durchsuchen{% endtrans %}
                        </button>
                        {% if zone.buryCount > 0 %}
                            <button id="uncover_ruin_button">
                                {% if (zone_blocked and active_scout_mode) %}
                                    <img class="icon right" alt="" src="{{ asset('build/images/uncloak.gif') }}" />
                                {% endif %}
                                <img class="icon left" alt="" src="{{ asset('build/images/uncover.gif') }}" />
                                {{ 'Zone freiräumen'|trans({},'game') }} (<div class="ap">1</div>)
                            </button>
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% embed "ajax/game/actions.html.twig" with {'heroic_action_list': heroics, 'item_action_list': actions, 'recipe_list': recipes, 'scout': (zone_blocked and active_scout_mode), 'hidden': citizen_hidden} %}
                {% endembed %}

            {% else %}

                {% if banished or town_chaos %}
                    <button {% if lock_trash %}disabled{% endif%} id="trash_button">{{ 'Müll durchwühlen'|trans({},'game') }} (<div class="ap">1</div>)</button>
                {% endif %}

            {% endif %}

            {% if allow_enter_town %}
                <button id="town-enter">
                    {% if zone.x == 0 and zone.y == 0 %}
                        {% trans from 'game' %}Stadt betreten{% endtrans %}
                    {% else %}
                        <img class="icon left" alt="" src="{{ asset('build/images/building/small_door_closed.gif') }}" />{% trans from 'game' %}In die Stadt zurückkehren{% endtrans %}
                    {% endif %}
                    {% if enter_costs_ap %}
                        (<div class="ap">1</div>)
                    {% endif %}
                </button>
            {% endif %}
            {% if show_ventilation %}
                <button id="town-enter-hero"{% if not allow_ventilation %}disabled{% endif %}><img alt="" src="{{ asset('build/images/star.gif') }}">{% trans from 'game' %}Durch die Lüftungsschächte klettern{% endtrans %}</button>
            {% endif %}
        </div>

        <div class="padded cell rw-6 rw-md-12">
            {% if zone.x != 0 or zone.y != 0 %}
            <h5>{% trans from 'game' %}Meine objekte{% endtrans %}</h5>
            {% embed "ajax/game/inventory.html.twig" with {'size': rucksack_size, 'items': rucksack.items, 'hidden': citizen_hidden} %}
                {% block class %}rucksack{% endblock %}
                {% block title %}{% trans from 'game' %}Rucksack{% endtrans %}{% endblock %}
            {% endembed %}
            {% endif %}

            {% if allow_floor_access %}
                {% if (zone_blocked and active_scout_mode) %}
                    <div class="note">
                        <b>{{ 'Achtung'|trans({},'global') }}</b>: {% trans from 'game' %}
                            Wenn du einen Gegenstand aufnimmst oder ablegst, verlierst du deine Tarnung!
                        {% endtrans %}
                    </div>
                {% endif %}

                {% if not citizen_hidden %}
                    <button id="drop-all-button" {% if rucksack.items|length == 0 %}disabled{% endif %}>{% trans from 'game' %}Rucksack auf dem Boden ausleeren{% endtrans %}</button>
                {% endif %}
                {% embed "ajax/game/inventory.html.twig" with {'size': 0, 'items': floor.items, 'hidden': citizen_hidden} %}
                    {% block class %}desert{% endblock %}
                    {% block title %}{% trans from 'game' %}Am Boden{% endtrans %}{% endblock %}
                {% endembed %}
            {% endif %}
        </div>
    </div>

    {% if other_citizens|length == 1 %}
        <div class="small">{{"Sie sind allein in dieser Gegend..."|trans({}, 'game')}}</div>
    {% else %}
        {% if citizen.validLeadingEscorts|length > 0 %}
            <h5>{% trans from 'game' %}Deine Eskorte{% endtrans %}</h5>
            <div class="row-table">
                {% set not_digging = 0 %}
                {% for other_citizen in other_citizens %}
                    {# @var other_citizen \App\Entity\Citizen #}
                    {% if other_citizen.escortSettings is not null and other_citizen.escortSettings.leader == citizen %}
                        {% if not other_citizen.digging %}
                            {% set not_digging = not_digging+1 %}
                        {% endif %}
                        <div class="row beyond-escort-on">
                            <div class="padded cell rw-4">
                                {% if other_citizen.online %}
                                    <img src="{{ asset('build/images/player_online.gif') }}" alt="{{ 'Online'|trans({},'global') }}">
                                {% else %}
                                    <img src="{{ asset('build/images/player_offline.gif') }}" alt="{{ 'Offline'|trans({},'global') }}">
                                {% endif %}
                                <img alt="{{ other_citizen.profession.label|trans({}, 'game') }}" src="{{ asset('build/images/professions/' ~ other_citizen.profession.icon ~ '.gif') }}">
                                <b>{{ other_citizen.user.username }}</b>
                            </div>
                            <div class="padded cell rw-3">
                                <ul class="status">
                                    {% if other_citizen.digging %}
                                        <li class="status">
                                            <img src="{{ asset('build/images/small_gather.gif') }}" alt="{{ 'In dieser Zone graben'|trans({},'game') }}">
                                            <div class="tooltip">
                                                <b>{% trans from 'game' %}Nächste automatische Ausgrabung:{% endtrans %}</b>
                                                <div class="center"><span x-countdown="{{ other_citizen.digTimeout }}" x-on-expire="">...</span></div>

                                            </div>
                                        </li>
                                    {% endif %}
                                    {% for stat in other_citizen.status %}
                                        {# @var stat \App\Entity\CitizenStatus #}
                                        {% if not stat.hidden %}
                                            <li class="status"><img src="{{ asset('build/images/status/status_' ~ stat.name ~ '.gif') }}" alt="{{ stat.label|trans({},'status') }}"></li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="padded cell rw-2">
                                <div class="ap small">{{ other_citizen.ap }}</div>
                            </div>
                            <div class="padded cell rw-3 right">
                                {% if zone.x != 0 or zone.y != 0 %}
                                    <button {% if other_citizen.digging or zone_blocked %}disabled{% else %}x-remote-action x-escort-control-endpoint="{{ path('beyond_desert_dig_controller', {ext: other_citizen.id}) }}"{% endif %} class="small inline" ><img alt="" src="{{ asset('build/images/small_gather.gif') }}"></button>
                                {% endif %}
                                <button x-toggle-escort="0" x-escort-control-endpoint="{{ path('beyond_desert_escort_controller', {cid: other_citizen.id}) }}" class="small inline" ><img alt="" src="{{ asset('build/images/escort_off.gif') }}"></button>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% if citizen.validLeadingEscorts|length > 1 %}
                    <div class="row beyond-escort-on beyond-escort-on-all">
                        <div class="padded cell rw-4">
                            <b>{{ 'Gesamte Eskorte'|trans({},'game') }}</b>
                        </div>
                        <div class="padded cell rw-8 right">
                            {% if not_digging > 1 and (zone.x != 0 or zone.y != 0) %}
                                <button {% if zone_blocked %}disabled{% else %}x-remote-action x-escort-control-endpoint="{{ path('beyond_desert_dig_controller', {ext: 'all'}) }}"{% endif %} class="small inline" ><img alt="" src="{{ asset('build/images/small_gather.gif') }}"></button>
                            {% endif %}
                            <button x-remote-action x-escort-control-endpoint="{{ path('beyond_desert_escort_drop_controller') }}" class="small inline" ><img alt="" src="{{ asset('build/images/escort_off.gif') }}"></button>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if other_citizens|length - citizen.validLeadingEscorts|length > 0 %}
            <h5>{% trans from 'game' %}Bürger in dieser Zone{% endtrans %}</h5>
            <div class="row-table">
                {% for other_citizen in other_citizens %}
                    {# @var other_citizen \App\Entity\Citizen #}
                    {% if other_citizen.escortSettings is null or other_citizen.escortSettings.leader != citizen %}
                        <div class="row beyond-escort-off">
                            <div class="padded cell rw-4">
                                {% if other_citizen.online %}
                                    <img src="{{ asset('build/images/player_online.gif') }}" alt="{{ 'Online'|trans({},'global') }}">
                                {% else %}
                                    <img src="{{ asset('build/images/player_offline.gif') }}" alt="{{ 'Offline'|trans({},'global') }}">
                                {% endif %}
                                <img alt="{{ other_citizen.profession.label|trans({}, 'game') }}" src="{{ asset('build/images/professions/' ~ other_citizen.profession.icon ~ '.gif') }}">
                                <b>{{ other_citizen.user.username }}</b>
                            </div>
                            <div class="padded cell rw-4">
                                <ul class="status">
                                    {% if other_citizen.camping %}
                                        <li class="status"><img src="{{ asset('build/images/status/status_camper.gif') }}" alt="{{ 'Camping'|trans({},'game') }}"></li>
                                    {% endif %}
                                    {% if other_citizen.digging %}
                                        <li class="status"><img src="{{ asset('build/images/small_gather.gif') }}" alt="{{ 'In dieser Zone graben'|trans({},'game') }}"></li>
                                    {% endif %}
                                    {% if other_citizen.escortSettings is not null and other_citizen.escortSettings.leader is not null %}
                                        <li class="status"><img src="{{ asset('build/images/escort_other.gif') }}" alt="{{ 'Eskorte'|trans({},'game') }}"></li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="padded cell rw-4 right">
                                {% if other_citizen != citizen %}
                                    {% if other_citizen.escortSettings is not null and other_citizen.escortSettings.leader is null %}
                                        <button {% if not citizen.profession.heroic %}disabled{% else %}x-toggle-escort="1" x-escort-control-endpoint="{{ path('beyond_desert_escort_controller', {cid: other_citizen.id}) }}"{% endif%} class="small inline" ><img alt="" src="{{ asset('build/images/escort_in.gif') }}"></button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}

    {% if not citizen.banished and not citizen.camping %}
        <div class="row">
            <div class="cell padded rw-12">
                {% if citizen.escortSettings is null and citizen.validLeadingEscorts|length == 0 %}
                    <button x-toggle-escort="1"><img alt="" src="{{ asset('build/images/escort_on.gif') }}" />{{ 'Eskorte aktivieren'|trans({},'game') }}</button>
                {% elseif citizen.escortSettings is not null %}
                    <button x-toggle-escort="0"><img alt="" src="{{ asset('build/images/escort_off.gif') }}" />{{ 'Eskorte deaktivieren'|trans({},'game') }}</button>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% if zone.x != 0 or zone.y != 0 %}
        <div class="row">
            <h5>{{ 'Zonenregister'|trans({},'game') }}</h5>
            <div class="cell rw-12">
                <div class="row">
                    <div class="padded cell rw-3 hide-lg hide-md hide-sm"><label for="beyond_chat">{{ 'Zonenchat'|trans({},'game') }}</label></div>
                    <div class="padded cell rw-8 rw-lg-10 rw-md-9 rw-sm-8"><input id="beyond_chat" type="text" placeholder="{{ 'Deine Nachricht'|trans({},'global') }}" /></div>
                    <div class="padded cell rw-1 rw-lg-2 rw-md-3 rw-sm-4"><button id="chat_button"><i class="fa fa-paper-plane"></i></button></div>
                </div>

            </div>
            <div class="cell rw-12">
                {% embed "ajax/game/log.html.twig" with {'log_content': log, 'log_source': path('beyond_desert_log_controller') } %}
                {% endembed %}
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block js %}
    {{ parent() }}
    <script>
        {% embed "scripts/actions.js.twig" %}{% endembed %};
        {% if zone.x != 0 or zone.y != 0 %}
            {% embed "scripts/log.js.twig" %}{% endembed %}
        {% endif %}

        $.html.addEventListenerAll( '[x-toggle-escort]:not([x-escort-control-endpoint])', 'click', function(e,elem) {
            $.ajax.easySend( '{{ path('beyond_desert_escort_self_controller') }}', {on: elem.getAttribute('x-toggle-escort') === '1'},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        $.html.addEventListenerAll( '[x-toggle-escort][x-escort-control-endpoint]', 'click', function(e,elem) {
            $.ajax.easySend( elem.getAttribute('x-escort-control-endpoint'), {on: elem.getAttribute('x-toggle-escort') === '1'},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        $.html.addEventListenerAll( '[x-remote-action][x-escort-control-endpoint]', 'click', function(e,elem) {
            $.ajax.easySend( elem.getAttribute('x-escort-control-endpoint'), {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        let sendLog = function() {
            $.ajax.easySend( '{{ path('beyond_desert_chat_controller') }}', { msg: document.getElementById('beyond_chat').value },
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        };

        $.html.addEventListenerAll( '#chat_button', 'click', function() {
            sendLog();
        })
        $.html.addEventListenerAll( '#beyond_chat', 'keypress', function(e) {
            if (!document.getElementById('chat_button')) return;
            if (e.key === "Enter")
                sendLog();
        });

        $.html.addEventListenerAll('#dig_button', 'click', function() {
            $.ajax.easySend( '{{ path('beyond_desert_dig_controller') }}', {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        $.html.addEventListenerAll('#dig_ruin_button', 'click', function() {
            $.ajax.easySend( '{{ path('beyond_desert_scavenge_controller') }}', {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        $.html.addEventListenerAll('#uncover_ruin_button', 'click', function() {
            $.ajax.easySend( '{{ path('beyond_desert_uncover_controller') }}', {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });

        {% if zone.x == 0 and zone.y == 0 and not lock_trash %}
            $.html.addEventListenerAll('#trash_button', 'click', function() {
                $.ajax.easySend( '{{ path('beyond_trash_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });
        {% endif %}

        {% if zone_blocked and zone_escape < 0 and not active_scout_mode %}
            $.html.addEventListenerAll('#escape-btn', 'click', function () {
                if (!confirm( '{{ 'Bestätigen?'|trans({}, 'global')|e('js') }}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_escape_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });
            $.html.addEventListenerAll('#attack-btn', 'click', function () {
                if (!confirm( '{{ 'Bestätigen?'|trans({}, 'global')|e('js') }}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_attack_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });
        {% endif %}

        {% if allow_floor_access %}
            {% embed "scripts/inventory.js.twig" %}{% endembed %}
            handleItems(
                document.querySelectorAll('.rucksack>.item:not(.locked)'),
                '{{ path('beyond_desert_item_controller') }}',
                'down', '{{ path('beyond_dashboard') }}'
            );

            handleItems(
                document.querySelectorAll('#drop-all-button'),
                '{{ path('beyond_desert_item_controller') }}',
                'down-all', '{{ path('beyond_dashboard') }}'
            );

            handleItems(
                document.querySelectorAll('.desert>.item:not(.locked)'),
                '{{ path('beyond_desert_item_controller') }}',
                'up', '{{ path('beyond_dashboard') }}'
            );

            handleHeroicActions(
                document.querySelectorAll('ul.heroic_actions li[x-action-id]:not([disabled])'),
                '{{ path('beyond_desert_heroic_controller') }}', '{{ path('beyond_dashboard') }}'
            );

            handleCampingActions(
              document.querySelectorAll('ul.camping_actions li[x-action-id]:not([disabled])'),
              '{{ path('beyond_desert_camping_controller') }}', '{{ path('beyond_dashboard') }}'
            );

            handleActions(
                document.querySelectorAll('ul.actions li[x-action-id][x-provoking-id]:not([disabled])'),
                '{{ path('beyond_desert_action_controller') }}', '{{ path('beyond_dashboard') }}'
            );

            handleActionPopups( document.querySelectorAll('ul.actions>li[x-target-definition]') );
            handleActionPopups( document.querySelectorAll('ul.heroic_actions>li[x-target-definition]') );

            handleRecipes(
                document.querySelectorAll('ul.actions>li[x-recipe-id]:not([disabled])'),
                '{{ path('beyond_desert_recipe_controller') }}', '{{ path('beyond_dashboard') }}'
            );
        {% endif %}

        {% if allow_enter_town %}
            $.html.addEventListenerAll('#town-enter', 'click', function() {
                if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_exit_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('game_landing') }}', true);
                    } );
            });
        {% endif %}
        {% if show_ventilation and allow_ventilation %}
            $.html.addEventListenerAll('town-enter-hero', 'click', function() {
                if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_hero_exit_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('game_landing') }}', true);
                    } );
            });
        {% endif %}
    </script>
{% endblock %}
