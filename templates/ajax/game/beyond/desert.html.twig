{% extends "ajax/game/beyond/beyond.html.twig" %}
{% block menu_text %}
    {{ parent() }}
{% endblock %}
{# @var zone \App\Entity\Zone #}
{% block content %}
    {% set hour = "now"|date("G") %}
    <div class="row">
        <div class="cell rw-12 zone-beyond time-{{ hour }} {% if hour < 7 or hour > 18 %}night-{% endif %}{% if zone.x == 0 and zone.y == 0 %}city{% elseif zone.prototype and zone.prototype.id > 0 %}oldruins{% else %}outerworld{% endif %}{% if zone.x == 0 and zone.y == 0 and zone.town.door == 1 %}-open{% endif %}"></div>
    </div>
    <div class="row">
        <div class="cell rw-12 {% if not zone.prototype %}ambiant {% endif %}small">
            {% if zone.x == 0 and zone.y == 0 %}
                <p>{% trans from 'game' %}Du lässt deinen Blick schweifen. Direkt vor dir erstreckt sich die gottverlassene Landschaft der Außenwelt. Du denkst an die anderen Stadtbewohner, die sich gerade draußen befinden und in den Ruinen graben. Du malst dir die Leiden all derer aus, die nicht mehr zurückkehren werden.{% endtrans %}</p>
                <p>{% trans from 'game' %}Möchtest du nun also nach draußen gehen oder entscheidest du dich dafür, in der Stadt zu bleiben? Manche sagen, dass man verrückt, andere wiederum, dass man gewieft sein muss, um die Außenwelt zu erkunden. Vielleicht trifft ja beides zu...{% endtrans %}</p>
            {% else %}
                {% if zone.prototype %}
                    <div class="ruin-info">
                        {% if zone.buryCount > 0 %}
                            <b>{{ 'Verschüttete Ruine'|trans({},'game') }}</b>
                            {% if scout %}<b>(<i>{{ zone.prototype.label|trans({}, 'game') }}</i>)</b>{% endif %}
                            <br />
                            {{ 'Es muss noch aufgeräumt werden'|trans({},'game') }}:
                            <div class="ruin-bury-count">{% for p in 1..zone.buryCount %}<div></div>{% endfor %}</div>
                        {% else %}
                            <img src="{{ asset('build/images/small_help.gif') }}" /> <span class="ruin-name">{{ 'Ruine'|trans({},'game') }} : <b>{{ zone.prototype.label|trans({}, 'game') }}</b></span><br />
                            <span class="ruin-desc">{{ zone.prototype.description|trans({}, 'game') }}</span>
                        {% endif %}

                    </div>
                {% else %}
                    <p class="beyond-rp">
                        <img alt="" src="{{ asset('build/images/small_rp.gif') }}" />
                        {% if hour >= 7 and hour <= 18 %}
                            {% trans from 'game' %}Die Wüste erstreckt sich, so weit das Auge reicht... Wie viele Männer sind in dieser Weite verloren gegangen? Wer weiß, ob Sie nicht der Nächste sind?{% endtrans %}
                        {% else %}
                            {% trans from 'game' %}Die Wüstennächte sind bitterkalt... Eine dicke Staubwolke umhüllt dich und du hörst schauriges Gekreische in deiner Umgebung. Ab und zu glaubst du eine unförmige Gestalt im Schatten wandeln zu sehen. Vielleicht geht auch nur deine Fantasie mit dir durch...{% endtrans %}
                        {% endif %}
                    </p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% if (zone.x != 0 or zone.y != 0) and conf.get(constant('App\\Structures\\TownConf::CONF_FEATURE_CAMPING'),false) %}
        <div class="row">
            <div class="cell rw-12 zone-camp">
                <input type="checkbox" name="zone-camp" id="zone-camp"{% if citizen_hidden %} checked="checked"{% endif %} /><label for="zone-camp">{% trans from 'game' %}Die Zone untersuchen{% endtrans %}</label>
                <div class="zone-camp-info">
                    <p>{% trans from 'game' %}Du schaust dir die Gegend etwas genauer an...{% endtrans %}</p>
                    {% if camping_zone != "" %}
                        <p>{{ camping_zone|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_zombies != "" %}
                        <p>{{ camping_zombies|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_chance != "" %}
                        <p class="emphasis">{{ camping_chance|trans({}, 'game') }}</p>
                    {% endif %}
                    {% if camping_improvable != "" %}
                        <p>{{ camping_improvable }}</p>
                    {% endif %}
                    {% if camping_blueprint != "" %}
                        <p>{{ camping_blueprint }}</p>
                    {% endif %}
                    {% if camping_debug != "" %}
                        <pre>{{ camping_debug }}</pre>
                    {% endif %}
                    {% embed "ajax/game/camping.html.twig" with {'list': camping, 'hidden': citizen_hidden} %}
                    {% endembed %}
                </div>
            </div>
        </div>
    {% endif %}
    {% if zone_blocked %}
        <div class="row">
            <div class="cell rw-12">
                <div class="zone-blocked-warning">
                    <b>
                        {% if zone_escape > 0 %}
                            {% trans from 'game' %}Temporäre Zonenkontrolle{% endtrans %}
                        {% else %}
                            {% trans with { '%z%': zone_zombies } from 'game' %}%z% Zombies kontrollieren diese Zone!{% endtrans %}
                        {% endif %}
                    </b><br />
                    <span>
                        {% if zone_escape > 0 %}
                            {% trans from 'game' %}
                                Das ist deine Chance - ergreife sie und fliehe! In Kürze werden die Zombies die Kontrolle über die Zone zurückerlangen. Dir verbleiden:
                            {% endtrans %}
                            <span x-countdown="{{ zone_escape }}" x-on-expire="reload">...</span>
                        {% elseif active_scout_mode %}
                            <br />
                            {% trans from 'game' %}
                                Dank deiner Tarnung kannst du dich dennoch bewegen - werde nur nicht zu übermütig...
                            {% endtrans %}
                            <br /><br />
                            <b>{{ 'Achtung'|trans({},'global') }}</b>: {% trans from 'game' %}
                                Bestimmte Aktionen können deine Tarnung auffliegen lassen!
                            {% endtrans %}
                        {% else %}
                            {% trans from 'game' %}
                                Du wurdest überrascht und bist jetzt von den Zombies umzingelt! Wenn du nichts unternimmst und dir niemand zu Hilfe eilt, wirst du ohne Zweifel heute Abend hier verrecken ...
                            {% endtrans %}
                        {% endif %}
                    </span>
                    {% if zone_escape <= 0 and not active_scout_mode %}
                        <div class="row">
                            <div class="padded-small cell rw-6"><button x-ajax-href="{{ url('forum_town_redirect') }}"><img alt="" src="{{ asset('build/images/attacked.gif') }}" />{% trans from 'game' %}Hilfe rufen!{% endtrans %}</button></div>
                            <div {% if not can_escape %}disabled{% endif %} class="padded-small cell rw-6"><button id="escape-btn"><img alt="" src="{{ asset('build/images/death.gif') }}" />{% trans from 'game' %}Die Flucht wagen!{% endtrans %}</button></div>
                        </div>
                        <div class="row">
                            <div {% if not can_attack %}disabled{% endif %} class="padded-small cell rw-8"><button id="attack-btn"><img alt="" src="{{ asset('build/images/fist.gif') }}" />{% trans from 'game' %}Gegen einen Zombie kämpfen!{% endtrans %} (<div class="ap">1</div>)</button></div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    {% endif %}
    <div class="row">
        <div class="padded cell rw-6 rw-md-12">
            <h5>{% trans from 'game' %}Diese Zone{% endtrans %}</h5>

            {% if zone.digs <= 0 %}
                <div class="note">
                    <img alt="" src="{{ asset('build/images/Small_broken.gif') }}" />
                    {% trans from 'game' %}
                        Diese Zone ist leergesucht. Du wirst hier keine wertvollen Gegenstände mehr finden können.
                    {% endtrans %}
                </div>
            {% endif %}

            <h5>{% trans from 'game' %}Meine Aktionen{% endtrans %}</h5>

            {% if zone.x != 0 or zone.y != 0 %}
                {% if not citizen_hidden %}
                    {% if not digging %}
                        {% if zone_blocked %}
                            <div class="note">
                                <img class="icon left" alt="" src="{{ asset('build/images/lock.gif') }}" />
                                {% trans from 'game' %}Während Zombies die Zone kontrollieren, kannst du nicht graben.{% endtrans %}
                            </div>
                        {% elseif dig_timeout > 0 %}
                            <div class="note">
                                <img class="icon left" alt="" src="{{ asset('build/images/lock.gif') }}" />
                                {% trans from 'game' %}Du hast hier bereits vor Kurzem gegraben. Die nächste Ausgrabung ist möglich in:{% endtrans %}
                                <b x-countdown="{{ dig_timeout }}" x-on-expire="reload">...</b>
                            </div>
                        {% endif %}
                        <button id="dig_button" {% if zone_blocked or dig_timeout > 0 %}disabled{% endif %}>
                            <img class="icon left" alt="" src="{{ asset('build/images/small_gather.gif') }}" />
                            {% trans from 'game' %}In dieser Zone graben{% endtrans %}</button>
                    {% else %}
                        <div class="note">
                            <img class="icon left" alt="" src="{{ asset('build/images/small_gather.gif') }}" />
                            {% trans from 'game' %}Nächste automatische Ausgrabung:{% endtrans %}
                            <span x-countdown="{{ dig_timeout }}" x-on-expire="reload">...</span>
                        </div>
                    {% endif %}
                    {% if zone.prototype %}
                        <button id="dig_ruin_button" {% if not dig_ruin or zone.buryCount > 0 %}disabled{% endif %} >
                            {% if (zone_blocked and active_scout_mode) %}
                                <img class="icon right" alt="" src="{{ asset('build/images/uncloak.gif') }}" />
                            {% endif %}
                            <img class="icon left" alt="" src="{{ asset('build/images/small_view.gif') }}" />
                            {% set ruin_label = zone.prototype.label|trans({},'game') %}
                            {% if zone.buryCount > 0 %}{% set ruin_label = 'Verschüttete Ruine'|trans({},'game') %}{% endif %}
                            {% trans with {'%ruin%': ruin_label} from 'game'  %}%ruin% durchsuchen{% endtrans %}
                        </button>
                        {% if zone.buryCount > 0 %}
                            <button id="uncover_ruin_button">
                                {% if (zone_blocked and active_scout_mode) %}
                                    <img class="icon right" alt="" src="{{ asset('build/images/uncloak.gif') }}" />
                                {% endif %}
                                <img class="icon left" alt="" src="{{ asset('build/images/uncover.gif') }}" />
                                {{ 'Zone freiräumen'|trans({},'game') }} (<div class="ap">1</div>)
                            </button>
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% embed "ajax/game/actions.html.twig" with {'heroic_action_list': heroics, 'item_action_list': actions, 'recipe_list': recipes, 'scout': (zone_blocked and active_scout_mode), 'hidden': citizen_hidden} %}
                {% endembed %}

            {% else %}

                {% if banished or town_chaos %}
                    <button {% if lock_trash %}disabled{% endif%} id="trash_button">{{ 'Müll durchwühlen'|trans({},'game') }} (<div class="ap">1</div>)</button>
                {% endif %}

            {% endif %}

            {% if allow_enter_town %}
                <button id="town-enter">
                    {% if zone.x == 0 and zone.y == 0 %}
                        {% trans from 'game' %}Stadt betreten{% endtrans %}
                    {% else %}
                        <img class="icon left" alt="" src="{{ asset('build/images/building/small_door_closed.gif') }}" />{% trans from 'game' %}In die Stadt zurückkehren{% endtrans %}
                    {% endif %}
                    {% if enter_costs_ap %}
                        (<div class="ap">1</div>)
                    {% endif %}
                </button>
            {% endif %}
            {% if show_ventilation %}
                <button id="town-enter-hero"{% if not allow_ventilation %}disabled{% endif %}><img alt="" src="{{ asset('build/images/star.gif') }}">{% trans from 'game' %}Durch die Lüftungsschächte klettern{% endtrans %}</button>
            {% endif %}
        </div>

        <div class="padded cell rw-6 rw-md-12">
            {% if zone.x != 0 or zone.y != 0 %}
            <h5>{% trans from 'game' %}Meine objekte{% endtrans %}</h5>
            {% embed "ajax/game/inventory.html.twig" with {'size': rucksack_size, 'items': rucksack.items, 'hidden': citizen_hidden} %}
                {% block class %}rucksack{% endblock %}
                {% block title %}{% trans from 'game' %}Rucksack{% endtrans %}{% endblock %}
            {% endembed %}
            {% endif %}

            {% if allow_floor_access %}
                {% if (zone_blocked and active_scout_mode) %}
                    <div class="note">
                        <b>{{ 'Achtung'|trans({},'global') }}</b>: {% trans from 'game' %}
                            Wenn du einen Gegenstand aufnimmst oder ablegst, verlierst du deine Tarnung!
                        {% endtrans %}
                    </div>
                {% endif %}

                {% if not citizen_hidden %}
                    <button id="drop-all-button" {% if rucksack.items|length == 0 %}disabled{% endif %}>{% trans from 'game' %}Rucksack auf dem Boden ausleeren{% endtrans %}</button>
                {% endif %}
                {% embed "ajax/game/inventory.html.twig" with {'size': 0, 'items': floor.items, 'hidden': citizen_hidden} %}
                    {% block class %}desert{% endblock %}
                    {% block title %}{% trans from 'game' %}Am Boden{% endtrans %}{% endblock %}
                {% endembed %}
            {% endif %}
        </div>
    </div>

    <div class="other_citizens">
    {% if other_citizens|length == 1 %}
        <em>{{"Sie sind allein in dieser Gegend..."|trans({}, 'game')}}</em>
    {% else %}
        {% for citizen in other_citizens %}
            {{ citizen.user.username }}<br />
        {% endfor %}
    {% endif %}
    </div>

    {% if zone.x != 0 or zone.y != 0 %}
        <div class="row">
            <h5>{{ 'Zonenregister'|trans({},'game') }}</h5>
            <div class="cell rw-12">
                <div class="row">
                    <div class="padded cell rw-3 hide-lg hide-md hide-sm"><label for="beyond_chat">{{ 'Zonenchat'|trans({},'game') }}</label></div>
                    <div class="padded cell rw-8 rw-lg-10 rw-md-9 rw-sm-8"><input id="beyond_chat" type="text" placeholder="{{ 'Deine Nachricht'|trans({},'global') }}" /></div>
                    <div class="padded cell rw-1 rw-lg-2 rw-md-3 rw-sm-4"><button id="chat_button"><i class="fa fa-paper-plane"></i></button></div>
                </div>

            </div>
            <div class="cell rw-12">
                {% embed "ajax/game/log.html.twig" with {'log_content': log, 'log_source': path('beyond_desert_log_controller') } %}
                {% endembed %}
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block js %}
    {{ parent() }}
    <script>
        {% embed "scripts/actions.js.twig" %}{% endembed %};
        {% if zone.x != 0 or zone.y != 0 %}
            {% embed "scripts/log.js.twig" %}{% endembed %}
        {% endif %}

        let sendLog = function() {
            $.ajax.easySend( '{{ path('beyond_desert_chat_controller') }}', { msg: document.getElementById('beyond_chat').value },
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        };
        let chat_button = document.getElementById('chat_button');
        if (chat_button)
            chat_button.addEventListener('click', function() {
                sendLog();
            });

        let beyond_chat = document.getElementById('beyond_chat');
        if (chat_button)
          beyond_chat.addEventListener('keypress', function(e) {
            if (e.key === "Enter") {
              sendLog();
            }
          });

        let dig_button = document.getElementById('dig_button');
        if (dig_button)
            dig_button.addEventListener('click', function() {
                $.ajax.easySend( '{{ path('beyond_desert_dig_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });
        let dig_r_button = document.getElementById('dig_ruin_button');
        if (dig_r_button)
            dig_r_button.addEventListener('click', function() {
                $.ajax.easySend( '{{ path('beyond_desert_scavenge_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });

        let uncover_r_button = document.getElementById('uncover_ruin_button');
        if (uncover_r_button)
            uncover_r_button.addEventListener('click', function() {
                $.ajax.easySend( '{{ path('beyond_desert_uncover_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                    } );
            });

        {% if zone.x == 0 and zone.y == 0 and not lock_trash %}
            let trash_button = document.getElementById('trash_button');
            if (trash_button)
                trash_button.addEventListener('click', function() {
                    $.ajax.easySend( '{{ path('beyond_trash_controller') }}', {},
                        function () {
                            $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                        } );
                });
        {% endif %}

        {% if zone_blocked and zone_escape < 0 and not active_scout_mode %}
        document.getElementById('escape-btn').addEventListener('click', function () {
            if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                return;
            $.ajax.easySend( '{{ path('beyond_desert_escape_controller') }}', {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });
        document.getElementById('attack-btn').addEventListener('click', function () {
            if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                return;
            $.ajax.easySend( '{{ path('beyond_desert_attack_controller') }}', {},
                function () {
                    $.ajax.load(null, '{{ path('beyond_dashboard') }}', true);
                } );
        });
        {% endif %}

        {% if allow_floor_access %}
        {% embed "scripts/inventory.js.twig" %}{% endembed %}
        handleItems(
            document.querySelectorAll('.rucksack>.item:not(.locked)'),
            '{{ path('beyond_desert_item_controller') }}',
            'down', '{{ path('beyond_dashboard') }}'
        );

        handleItems(
            document.querySelectorAll('#drop-all-button'),
            '{{ path('beyond_desert_item_controller') }}',
            'down-all', '{{ path('beyond_dashboard') }}'
        );

        handleItems(
            document.querySelectorAll('.desert>.item:not(.locked)'),
            '{{ path('beyond_desert_item_controller') }}',
            'up', '{{ path('beyond_dashboard') }}'
        );

        handleHeroicActions(
            document.querySelectorAll('ul.heroic_actions li[x-action-id]:not([disabled])'),
            '{{ path('beyond_desert_heroic_controller') }}', '{{ path('beyond_dashboard') }}'
        );

        handleCampingActions(
          document.querySelectorAll('ul.camping_actions li[x-action-id]:not([disabled])'),
          '{{ path('beyond_desert_camping_controller') }}', '{{ path('beyond_dashboard') }}'
        );

        handleActions(
            document.querySelectorAll('ul.actions li[x-action-id][x-provoking-id]:not([disabled])'),
            '{{ path('beyond_desert_action_controller') }}', '{{ path('beyond_dashboard') }}'
        );

        handleActionPopups( document.querySelectorAll('ul.actions>li[x-target-definition]') );
        handleActionPopups( document.querySelectorAll('ul.heroic_actions>li[x-target-definition]') );

        handleRecipes(
            document.querySelectorAll('ul.actions>li[x-recipe-id]:not([disabled])'),
            '{{ path('beyond_desert_recipe_controller') }}', '{{ path('beyond_dashboard') }}'
        );
        {% endif %}
        {% if allow_enter_town %}
            document.getElementById('town-enter').addEventListener('click', function() {
                if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_exit_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('game_landing') }}', true);
                    } );
            });
        {% endif %}
        {% if show_ventilation and allow_ventilation %}
            document.getElementById('town-enter-hero').addEventListener('click', function() {
                if (!confirm( '{% trans from 'global' %}Bestätigen?{% endtrans %}' ))
                    return;
                $.ajax.easySend( '{{ path('beyond_desert_hero_exit_controller') }}', {},
                    function () {
                        $.ajax.load(null, '{{ path('game_landing') }}', true);
                    } );
            });
        {% endif %}
    </script>
{% endblock %}
