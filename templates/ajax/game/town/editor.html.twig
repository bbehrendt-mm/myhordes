<div class="forum-editor">
    {% if tid == -1 %}
        <div class="row">
            <div class="cell rw-4 padded">
                <label for="forum-editor-title">{{ 'Titel'|trans({},'global') }}</label>
            </div>
            <div class="cell rw-8 padded">
                <input type="text" id="forum-editor-title{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" />
            </div>
        </div>
    {% endif %}
    <div class="row">
        <div class="cell rw-12">
            <ul class="tabs" x-tab-group="forum-editor{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" x-tab-control>
                <li x-tab-id="classic{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}">{% trans from 'game' %}Klassischer Editor{% endtrans %}</li>
                <li x-tab-id="suneditor{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}">{% trans from 'game' %}Grafischer Editor{% endtrans %}</li>
            </ul>
        </div>

    </div>
    <div x-tab-group="forum-editor{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" x-tab-id="classic{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" x-tab-target>
        <div class="row classic-editor">
            <div class="padded cell rw-12">
                <label>{{ 'Vorschau'|trans({},'global') }}</label>
                <div id="forum-editor-preview{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}"></div>
                <br />
                <label for="forum-editor-text">{{ 'Deine Nachricht'|trans({},'global') }}</label>
                <div class="forum-button-bar">
                    <div x-forum-action="edit" x-text-wrap-node="b" class="forum-button"><i class="fa fa-bold"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="i" class="forum-button"><i class="fa fa-italic"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="u" class="forum-button"><i class="fa fa-underline"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="s" class="forum-button"><i class="fa fa-strikethrough"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="ul" class="forum-button"><i class="fa fa-list-ul"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="ol" class="forum-button"><i class="fa fa-list-ol"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="li" class="forum-button"><i class="fa fa-star-of-life"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="spoiler" class="forum-button"><i class="fa fa-eye-slash"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="quote" class="forum-button"><i class="fa fa-quote-left"></i></div>
                    <div x-forum-action="edit" x-text-wrap-node="glory" class="forum-button"><i class="fa fa-crown"></i></div>
                    <div x-forum-action="edit" x-text-insert-node="hr" class="forum-button"><i class="fa fa-grip-lines"></i></div>
                </div>

                <textarea id="forum-editor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}"></textarea>

                <div class="row">
                    <div class="padded cell rw-12">
                        <div class="forum-button-bar">
                            {% for tag,url in emotes %}
                                <div x-forum-action="edit" x-text-emote="{{ asset(url) }}" x-text-insert-emote="{{ tag }}" class="forum-button-inline"><img alt="{{ tag }}" src="{{ asset(url) }}"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div x-tab-group="forum-editor{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" x-tab-id="suneditor{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}" x-tab-target>
        <div class="row modern-editor">
            <div class="padded cell rw-12">
                <label for="forum-suneditor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}">{{ 'Deine Nachricht'|trans({},'global') }}</label>
                <textarea id="forum-suneditor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}"></textarea>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="padded cell rw-12 right">
            <button x-forum-action="send{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}">{{ 'Ich BESTÃ„TIGE meine Nachright'|trans({},'game') }}</button>
        </div>
    </div>

</div>
<script>
    (function() {

        let node_transfer_source = document.getElementById('forum-editor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}');
        let node_transfer_target = document.getElementById('forum-editor-preview{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}');
        const transfer_to_preview = function() {

            let container_node = document.createElement('p');
            container_node.innerText = node_transfer_source.value.replace(/(\r\n|\n|\r)/gm,'{br}');

            const lego = function(blocks,elem) {
                for (let i = 0; i < blocks.length; i++) {
                    if (!blocks[i]) continue;
                    let node = null;
                    if (typeof blocks[i] === 'string')
                        node = document.createTextNode( blocks[i] );
                    if (typeof blocks[i] === 'object') {
                        node = document.createElement( blocks[i][1] );
                        node.appendChild( document.createTextNode( blocks[i][0] ) );
                        if (blocks[i][2]) node.classList.add(blocks[i][2]);
                        if (blocks[i][3]) for (let j = 0; j < blocks[i][3].length; j += 2)
                            node.setAttribute(blocks[i][3][j], blocks[i][3][j+1]);
                    }
                    if (node) elem.parentNode.insertBefore(node, elem);
                }
                elem.parentNode.removeChild(elem);
            }

            const parseRangeBlocks = function(elem, secondary = false) {
                let changed = false;
                if (elem.nodeType === Node.TEXT_NODE) {
                    const str = elem.textContent;
                    const regex_wrappers = !secondary ? /\[(.*?)]([\s\S]*?)\[\/\1]/gm : /(?:([^\w\s]){2})([\s\S]*?)\1{2}/gm;
                    let current_offset = 0;
                    let blocks = [];

                    for (const match of str.matchAll( regex_wrappers )) {
                        if (current_offset < match.index )
                            blocks.push(str.substr(current_offset,match.index-current_offset));

                        const tag = match[1].toLowerCase();
                        if (!secondary) switch (tag) {
                            case 'b': case 'i': case 'u': case 's': case 'ul': case 'ol': case 'li': blocks.push( [ match[2], tag, null] ); changed = true; break;
                            case 'spoiler': case 'glory': blocks.push( [ match[2], 'div', tag] ); changed = true; break;
                            case 'quote': blocks.push( [ match[2], 'blockquote', null] ); changed = true; break;
                            default: blocks.push( match[0] ); break;
                        } else switch (tag) {
                            case '*': blocks.push( [ match[2], 'b', null] ); changed = true; break;
                            case '/': blocks.push( [ match[2], 'i', null] ); changed = true; break;
                            case '-': blocks.push( [ match[2], 's', null] ); changed = true; break;
                            default: blocks.push( match[0] ); break;
                        }
                        current_offset = (match[0].length + match.index);
                    }

                    if (blocks.length === 0) blocks.push( str );
                    else if (current_offset < str.length) blocks.push( str.substr( current_offset ) );

                    lego(blocks,elem);
                } else if (elem.nodeType === Node.ELEMENT_NODE) {
                    let children = elem.childNodes;
                    for (let i = 0; i < children.length; i++)
                        changed |= parseRangeBlocks(children[i],secondary);
                }
                return changed;
            }
            const parseEmotes = function(elem) {
                if (elem.nodeType === Node.TEXT_NODE) {
                    const str = elem.textContent;
                    const regex_wrappers = /(?::(\w+?):)|([:;].)/g;
                    let current_offset = 0;
                    let blocks = [];

                    for (const match of str.matchAll( regex_wrappers )) {

                        if (current_offset < match.index )
                            blocks.push(str.substr(current_offset,match.index-current_offset));

                        let tag = null;
                        if (match[1])
                            tag = match[0].toLowerCase();
                        else if (match[2])
                            switch (match[0]) {
                                case ':)': tag = ':smile:';    break;
                                case ':D': tag = ':lol:';      break;
                                case ':(': tag = ':sad:';      break;
                                case ';)': tag = ':smile:';    break;
                                case ':O': tag = ':surprise:'; break;
                            }

                        let ctrl = tag ? document.querySelector('[x-text-emote][x-text-insert-emote="' + tag + '"]') : null;
                        if (ctrl)
                            blocks.push( [ '', 'img', null, ['src', ctrl.getAttribute('x-text-emote'), 'x-foxy-proxy', tag]] );
                        else blocks.push( match[0] );
                        current_offset = (match[0].length + match.index);
                    }

                    if (blocks.length === 0) blocks.push( str );
                    else if (current_offset < str.length) blocks.push( str.substr( current_offset ) );

                    lego(blocks,elem);
                } else {
                    let children = elem.childNodes;
                    for (let i = 0; i < children.length; i++)
                        parseEmotes(children[i]);
                }
            }

            let changed = true;
            while (changed) changed &= parseRangeBlocks(container_node,false);
            parseEmotes(container_node);

            changed = true;
            while (changed) changed &= parseRangeBlocks(container_node,true);

            let c = null;
            while ((c = node_transfer_target.lastChild))
                node_transfer_target.removeChild(c)

            while ((c = container_node.firstChild))
                node_transfer_target.appendChild(c);
        }

        node_transfer_source.addEventListener('input', transfer_to_preview);

        $.html.addEventListenerAll( '[x-forum-action="edit"][x-text-wrap-node]', 'click', function (e,elem) {
            e.preventDefault();
            e.stopPropagation();

            const tag = elem.getAttribute('x-text-wrap-node');
            const content = node_transfer_source.value;
            const s_start = node_transfer_source.selectionStart;
            const s_end = node_transfer_source.selectionEnd;

            node_transfer_source.value =
                content.substr( 0, s_start ) +
                '[' + tag + ']' +
                content.substr( s_start, s_end - s_start ) +
                '[/' + tag + ']' +
                content.substr( s_end );

            node_transfer_source.setSelectionRange( s_start + tag.length + 2, s_end + tag.length + 2 );
            window.setTimeout( function() {node_transfer_source.focus()}, 10 )
            transfer_to_preview();
        } );
        $.html.addEventListenerAll( '[x-forum-action="edit"][x-text-insert-node]', 'click', function (e,elem) {
            e.preventDefault();
            e.stopPropagation();

            const tag = elem.getAttribute('x-text-insert-node');
            const content = node_transfer_source.value;
            const s_start = node_transfer_source.selectionStart;
            const s_end = node_transfer_source.selectionEnd;

            node_transfer_source.value =
                content.substr( 0, s_start ) +
                '{' + tag + '}' +
                content.substr( s_start );

            node_transfer_source.setSelectionRange( s_start + tag.length + 2, s_end + tag.length + 2 );
            window.setTimeout( function() {node_transfer_source.focus()}, 10 )
            transfer_to_preview();
        } );
        $.html.addEventListenerAll( '[x-forum-action="edit"][x-text-insert-emote][x-text-emote]', 'click', function (e,elem) {
            e.preventDefault();
            e.stopPropagation();

            const tag = elem.getAttribute('x-text-insert-emote');
            const content = node_transfer_source.value;
            const s_start = node_transfer_source.selectionStart;
            const s_end = node_transfer_source.selectionEnd;

            node_transfer_source.value =
                content.substr( 0, s_start ) + tag + content.substr( s_start );

            node_transfer_source.setSelectionRange( s_start + tag.length, s_end + tag.length );
            window.setTimeout( function() {node_transfer_source.focus()}, 10 )
            transfer_to_preview();
        } );


        const sun_editor_plugin_base = function(name, title, innerHTML, tag, classNameInternal, classNameExternal) {
            return {
                // @Required @Unique
                // plugin name
                name: name,
                // @Required
                // data display
                display: 'command',

                // @Options
                title: title,
                buttonClass: '',
                innerHTML: innerHTML,

                // @Required
                // add function - It is called only once when the plugin is first run.
                // This function generates HTML to append and register the event.
                // arguments - (core : core object, targetElement : clicked button element)
                add: function (core, targetElement) {
                    const context = core.context;
                    const new_tag = core.util.createElement(tag);
                    core.util.addClass(new_tag, classNameInternal);
                    for (let i = 0; i < classNameExternal.length; i++)
                        core.util.addClass(new_tag, classNameExternal[i]);

                    // @Required
                    // Registering a namespace for caching as a plugin name in the context object
                    context[name + '_command'] = {
                        targetButton: targetElement,
                        tag: new_tag
                    };
                },

                // @Overriding
                // Plugins with active methods load immediately when the editor loads.
                // Called each time the selection is moved.
                active: function (element) {
                    if (!element) {
                        this.util.removeClass(this.context[name + '_command'].targetButton, 'active');
                    } else if (this.util.hasClass(element, classNameInternal)) {
                        this.util.addClass(this.context[name + '_command'].targetButton, 'active');
                        return true;
                    }

                    return false;
                },
            }
        }
        const sun_editor_range_prototype = function(name, title, innerHTML, tag, classNameInternal, classNameExternal) {
            let base = sun_editor_plugin_base(name, title, innerHTML, tag, classNameInternal, classNameExternal);
            base.action = function () {
                // @Required
                // The behavior of the "command plugin" must be defined in the "action" method.
                const new_tag = this.util.getRangeFormatElement(this.getSelectionNode());

                if (this.util.hasClass(new_tag, classNameInternal)) {
                    this.detachRangeFormatElement(new_tag, null, null, false, false);
                } else {
                    this.applyRangeFormatElement(this.context[name + '_command'].tag.cloneNode(false));
                }
            }
            return base;
        }
        const spoiler_command = sun_editor_range_prototype('spoiler','Spoiler','<i class="fas fa-carrot"></i>','div','__se__format__spoiler',['spoiler']);
        const glory_command   = sun_editor_range_prototype('glory','Glory','<i class="fas fa-crown"></i>','div','__se__format__glory',['glory']);

        const editor = SUNEDITOR.create((document.getElementById('forum-suneditor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}') || 'forum-suneditor-text{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}'),{
            // All of the plugins are loaded in the "window.SUNEDITOR" object in dist/suneditor.min.js file
            plugins : {
                spoiler_command,
                glory_command
            },
            buttonList: [
                ['undo', 'redo'],
                ['bold', 'underline', 'italic', 'strike'],
                ['removeFormat'],
                ['outdent', 'indent', 'list'],
                ['blockquote', 'link' {% if app.user.rightsElevation >= 4 %}, 'image'{% endif %}],
                ['spoiler', 'glory'],
            ],
            // Insert options
            // Language global object (default: en)
            //lang: SUNEDITOR_LANG."{{ (app.request.locale|e('html_attr')|split('_', 2))[0] }}"
        });

        let send_buttons = document.querySelectorAll('[x-forum-action=send{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}]');
        for (let i = 0; i < send_buttons.length; i++) {
            send_buttons[i].addEventListener('click', function(e) {
                e.preventDefault();
                let target_url, target_payload;
                let type = document.querySelector("input[name=post-type]:checked") ? document.querySelector("input[name=post-type]:checked").value : null;

                // Replace proxies
                let content_node = document.querySelector('[x-tab-id{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}="classic"].selected')
                    ? document.getElementById('forum-editor-preview{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}').cloneNode(true)
                    : document.querySelector('.sun-editor-editable').cloneNode(true);

                let proxies = content_node.querySelectorAll('[x-foxy-proxy]');
                for (let j = 0; j < proxies.length; j++) {
                    if (!proxies[j].parentNode) continue;
                    proxies[j].parentNode.insertBefore(document.createTextNode(proxies[j].getAttribute('x-foxy-proxy')), proxies[j]);
                    proxies[j].parentNode.removeChild(proxies[j]);
                }

                target_url = '{{ path('town_house_send_pm_controller') }}';
                target_payload = {
                    content: content_node.innerHTML
                };
                {% if global %}
                    target_payload.global = true;
                {% else %}
                    target_payload.global = false;
                    {% if tid != -1 %}
                        target_payload.tid = "{{ tid }}";
                    {% else %}
                        target_payload.title = document.getElementById("forum-editor-title{% if global %}-global{% elseif tid != -1 %}-answer{% endif %}").value;
                        target_payload.recipient = document.getElementById('pmidrecipient').value;
                    {% endif %}
                {% endif %}
                $.ajax.easySend( target_url, target_payload,
                    function () {
                    $.ajax.load(null, '{{ path('town_house', {'tab': 'messages', 'subtab': 'received'}) }}', true);
                } );
            });
        }
    })();
</script>